# Dead Code Detection

## What is Dead Code

Code that:
- Never executed
- No longer needed
- Commented out
- Unreachable
- Deprecated but not removed

## Detection Methods

### 1. Static Analysis

**PHPStan**:
```bash
phpstan analyse src --level=9
```

Finds:
- Unused private methods
- Unused variables
- Unreachable code

**Psalm**:
```bash
psalm --find-dead-code
```

### 2. Coverage Reports

```bash
phpunit --coverage-html build/coverage
```

0% covered code might be dead (or untested).

### 3. IDE Analysis

PhpStorm: Analyze → Inspect Code → "Unused declaration"

### 4. Git History

```bash
# Find files not changed in 2 years
git log --since="2 years ago" --name-only --pretty=format: | sort -u > recent_files.txt
find src -name "*.php" | grep -v -f recent_files.txt
```

### 5. Runtime Analysis

Add logging to suspect code:
```php
public function suspectMethod() {
    $this->logger->warning('suspectMethod called'); // Monitor for a week
}
```

## Common Dead Code Patterns

### Commented Code
```php
// public function oldMethod() {
//     return $this->legacyService->call();
// }
```
**Fix**: Delete it (git has history)

### Feature Flags Never Enabled
```php
if ($this->featureFlag->isEnabled('never_enabled_feature')) {
    // This code never runs
}
```
**Fix**: Remove flag and code

### Unused Classes
```php
// Generated by framework scaffolding but never used
class UnusedController {}
```
**Fix**: Delete file

### Deprecated Methods
```php
/**
 * @deprecated Use newMethod() instead
 */
public function oldMethod() {}
```
**Fix**: Remove after migration period

### Unreachable Code
```php
return $result;
$this->log('Never executed'); // Unreachable
```
**Fix**: PHPStan will detect this

## Removal Process

### 1. Identify
- Run static analysis
- Check coverage
- Review git log

### 2. Verify
- Search for usages (IDE + grep)
- Check reflection/dynamic calls
- Review tests

### 3. Mark for Removal
```php
/**
 * @deprecated Will be removed in v2.0
 * Use WorkoutService::create() instead
 */
```

### 4. Remove
- Delete code
- Remove tests
- Update documentation
- Commit with clear message

## Example: Clean Unused Service

```bash
# 1. Find unused services
php bin/console debug:container --show-private | grep "unused"

# 2. Check references
grep -r "UnusedService" src/

# 3. Remove from services.yaml
# 4. Delete file
rm src/Service/UnusedService.php

# 5. Run tests
phpunit
```

## Refactoring Patterns

### Extract Method → Inline
If extracted method used once:
```php
// Before
public function process() {
    $result = $this->doSomething();
    return $result;
}
private function doSomething() { return 42; }

// After
public function process() {
    return 42;
}
```

### Dead Dependency
```php
// composer.json
{
    "require": {
        "vendor/package": "^1.0"  // Not used anywhere
    }
}
```
```bash
composer remove vendor/package
```

## Monitoring Dead Code

### Metrics to Track
- % of 0-coverage code
- PHPStan unused warnings
- Time since last change (per file)

### Regular Cleanup
- Quarterly dead code sprints
- Before major releases
- After feature flag removal

## Safety Checklist

- [ ] No grep matches in src/
- [ ] No test failures after removal
- [ ] No runtime errors in staging
- [ ] CI/CD passes
- [ ] Deployment successful
